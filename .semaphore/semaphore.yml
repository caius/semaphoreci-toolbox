version: v1.0
name: Toolbox S2 project
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

execution_time_limit:
  minutes: 10

global_job_config:
  prologue:
    commands:
      # Disconnect from cache server
      - checkout
      - bash release/create.sh

blocks:
  - name: Static Code Analysis
    dependencies: []
    task:
      prologue:
        commands:
          - sudo apt-get install shellcheck
      jobs:
        - name: ShellCheck
          commands:
            - shellcheck sem-service || true
            - shellcheck sem-version || true
            - shellcheck cache       || true
            - shellcheck libcheckout || true
            - 'shellcheck sem-service -f gcc | wc -l && [[ "$(shellcheck sem-service -f gcc | wc -l)" -le 76 ]]'
            - 'shellcheck sem-version -f gcc | wc -l && [[ "$(shellcheck sem-version -f gcc | wc -l)" -le 21 ]]'
            - 'shellcheck cache       -f gcc | wc -l && [[ "$(shellcheck cache -f gcc | wc -l)" -le 152 ]]'
            - 'shellcheck libcheckout -f gcc | wc -l && [[ "$(shellcheck libcheckout -f gcc | wc -l)" -le 89 ]]'
            - shellcheck install-package

  - name: Sem Version Tests bionic
    dependencies: []
    task:
      prologue:
        commands:
          - source release/install_in_tests.sh
          - git submodule init && git submodule update
          - sudo ./tests/support/bats-core/install.sh /usr/local

      jobs:
        - name: Sem Version
          commands:
            - bats tests/sem_version_bionic.bats

